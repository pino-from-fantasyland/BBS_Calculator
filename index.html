<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BBS Assessment Tool v1.00</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #2c3e50; --accent: #0056b3; --accent-light: #e7f1ff; --bg-color: #f4f6f9; --border-color: #ced4da; --text-main: #212529; --text-muted: #6c757d; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 15px; line-height: 1.6; }
    .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    h1 { font-size: 1.5rem; color: var(--primary); text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 12px; margin-top: 0;}
    .control-panel { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid var(--border-color); }
    .control-group { margin-bottom: 12px; }
    .control-group label { font-weight: bold; display: block; margin-bottom: 6px; font-size: 0.9rem; }
    select, input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
    .bbs-item { margin-bottom: 30px; }
    .bbs-item-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .radio-group-vertical { display: flex; flex-direction: column-reverse; gap: 8px; }
    .radio-option { display: flex; align-items: center; padding: 12px 16px; background: #fff; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative; }
    .radio-option input[type="radio"] { position: absolute; opacity: 0; }
    .score-badge { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--border-color); font-weight: bold; font-size: 1.1rem; margin-right: 16px; flex-shrink: 0; color: var(--text-muted); background-color: #fff; }
    .criteria-text { font-size: 1rem; line-height: 1.4; }
    .radio-option:has(input[type="radio"]:checked) { background-color: var(--accent-light); border-color: var(--accent); }
    .radio-option:has(input[type="radio"]:checked) .score-badge { background-color: var(--accent); border-color: var(--accent); color: #fff; }
    .radio-option:has(input[type="radio"]:checked) .criteria-text { font-weight: bold; color: var(--accent); }
    
    #result-panel { margin-top: 40px; padding: 25px 20px; border-radius: 12px; text-align: center; background: #fff; border: 2px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .score-display { font-size: 3rem; margin: 10px 0; color: var(--primary); font-weight: bold; }
    .max-score { font-size: 1.5rem; color: var(--text-muted); }
    
    #chart-container { position: relative; height: 320px; width: 100%; margin-bottom: 20px; display: none; }
    #progress-wrapper { position: relative; margin: 40px 0 20px 0; display: none; }
    #progress-container { width: 100%; background-color: #e9ecef; border-radius: 15px; height: 25px; overflow: hidden; }
    #progress-bar { height: 100%; background-color: var(--accent); transition: width 0.5s ease; width: 0%; }
    .cutoff-marker { position: absolute; top: -15px; width: 3px; height: 55px; background-color: #dc3545; z-index: 10; transform: translateX(-50%); border-radius: 2px; }
    .cutoff-label { position: absolute; top: -35px; transform: translateX(-50%); font-size: 0.85rem; font-weight: bold; color: #dc3545; white-space: nowrap; background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #dc3545; }
    
    #screening-alerts { display: none; text-align: left; margin: 20px 0; }
    .alert-box { padding: 12px; border-radius: 6px; margin-bottom: 8px; font-weight: bold; display: flex; align-items: center; }
    .alert-safe { background-color: #d4edda; color: #155724; border-left: 5px solid #28a745; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
    
    .status-good { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724;}
    .status-warn { background-color: #fff3cd !important; border-color: #ffeeba !important; color: #856404;}
    .status-alert { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24;}
    #cutoff-message { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 6px;}
    
    #mdc-result { display: none; margin-top: 15px; padding: 15px; border-radius: 8px; border: 2px dashed var(--border-color); text-align: left; line-height: 1.5; font-size: 0.95rem; }
    .mdc-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; border-bottom: 1px solid currentColor; padding-bottom: 4px;}

    .ref-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; justify-content: center; }
    .btn-ref { padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; cursor: pointer; background: #fff; color: var(--primary); }
    .btn-ref:hover { background: var(--accent-light); border-color: var(--accent); }
    #reference-panel { display: none; margin-top: 10px; padding: 12px; border-radius: 8px; background: #f8f9fa; border: 1px solid var(--border-color); text-align: left; font-size: 0.85rem; line-height: 1.6; color: var(--text-main); }
    #reference-panel .ref-heading { font-weight: bold; margin-bottom: 6px; color: var(--primary); }
    #reference-panel .ref-entry { margin-bottom: 10px; }
    #reference-panel .ref-entry:last-child { margin-bottom: 0; }

    .btn { padding: 10px 15px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-primary { background-color: var(--primary); color: white; width: 100%; margin-top: 20px;}
    .btn-primary:hover { background-color: #1a252f; }
    .btn-secondary { background-color: #6c757d; color: white; white-space: nowrap;}
    .btn-secondary:hover { background-color: #5a6268; }
    .flex-row { display: flex; gap: 10px; align-items: stretch; }
    #history-message { margin-top: 15px; font-size: 0.95rem; font-weight: bold; color: var(--accent); }
  </style>
</head>
<body>

<div class="container">
  <h1>BBS Assessment Tool</h1>

  <div class="control-panel">
    <div class="control-group">
      <label>æ‚£è€…IDï¼ˆâ€»æ°åãªã©å€‹äººç‰¹å®šæƒ…å ±ã¯å…¥åŠ›ã—ãªã„ã“ã¨ï¼‰</label>
      <div class="flex-row">
        <input type="text" id="patientId" placeholder="ä¾‹: 1234-A">
        <button id="loadBtn" class="btn btn-secondary">å±¥æ­´èª­è¾¼</button>
      </div>
      <div id="history-message"></div>
    </div>

    <div class="control-group">
      <label>è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰</label>
      <select id="evalMode">
        <option value="full">ãƒ•ãƒ«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (14é …ç›® / ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ)</option>
        <option value="bbs9">æ™‚çŸ­ãƒ¢ãƒ¼ãƒ‰: BBS-9 (9é …ç›® / é”æˆåº¦ãƒãƒ¼)</option>
        <option value="screening">é«˜é›£æ˜“åº¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚° (å¾ŒåŠ4é …ç›®)</option>
      </select>
    </div>
    <div class="control-group">
      <label>æ‚£è€…å±æ€§ï¼ˆã‚«ãƒƒãƒˆã‚ªãƒ•ãƒ»MDCåˆ¤å®šç”¨ï¼‰</label>
      <select id="patientProfile">
        <option value="elderly">ä¸€èˆ¬çš„ãªé«˜é½¢è€…</option>
        <option value="stroke">è„³å’ä¸­ï¼ˆå…¥é™¢æ™‚ï¼‰</option>
        <option value="pd">ãƒ‘ãƒ¼ã‚­ãƒ³ã‚½ãƒ³ç—…</option>
      </select>
    </div>
  </div>

  <div id="evaluation-form"></div>

  <div id="result-panel">
    <div>åˆè¨ˆã‚¹ã‚³ã‚¢</div>
    <div class="score-display">
      <span id="total-score">-</span><span class="max-score"> / <span id="max-score">56</span></span>
    </div>

    <div id="chart-container"><canvas id="radarChart"></canvas></div>
    
    <div id="progress-wrapper">
      <div id="cutoff-marker-container"></div>
      <div id="progress-container"><div id="progress-bar"></div></div>
    </div>
    
    <div id="screening-alerts"></div>
    <div id="cutoff-message">ã™ã¹ã¦ã®é …ç›®ã‚’è©•ä¾¡ã™ã‚‹ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>

    <div class="ref-buttons">
      <button type="button" id="btnCutoffRef" class="btn-ref">ğŸ“š ã‚«ãƒƒãƒˆã‚ªãƒ•ã®å‡ºå…¸</button>
      <button type="button" id="btnMdcRef" class="btn-ref">ğŸ“š MDCã®å‡ºå…¸</button>
    </div>
    <div id="reference-panel"></div>

    <div id="mdc-result"></div>

    <button id="saveBtn" class="btn btn-primary" style="display: none;">ã“ã®çµæœã‚’ä¿å­˜ã™ã‚‹</button>
  </div>
</div>

<script>
  // ã‚°ãƒ©ãƒ•æç”»ç”¨ã®çŸ­ã„ã‚¿ã‚¤ãƒˆãƒ« (shortTitle) ã‚’è¿½åŠ ï¼
  const bbsItems = [
    { id: 1, title: "1. åº§ä½ã‹ã‚‰ã®ç«‹ã¡ä¸ŠãŒã‚Š", shortTitle: "èµ·ç«‹", isBBS9: true, isScreening: false, criteria: ["ä¸­ç­‰åº¦ã€œæœ€å¤§ä»‹åŠ©", "æœ€å°ä»‹åŠ©", "è¤‡æ•°å›ã®è©¦è¡Œã§æ‰‹ã‚’ä½¿ç”¨ã—èµ·ç«‹", "æ‰‹ã‚’ä½¿ç”¨ã—ã¦è‡ªç«‹", "æ‰‹ã‚’ä½¿ã‚ãšã«ç«‹ã¡ä¸ŠãŒã‚Šè‡ªç«‹å®‰å®š"] },
    { id: 2, title: "2. ç«‹ä½ä¿æŒï¼ˆæ”¯æŒãªã—ï¼‰", shortTitle: "ç«‹ä½ä¿æŒ", isBBS9: true, isScreening: false, criteria: ["30ç§’ä¿æŒä¸èƒ½", "30ç§’é–“ã«è¤‡æ•°å›ã®è©¦è¡Œ", "30ç§’é–“è‡ªç«‹", "2åˆ†é–“ç›£è¦–ä¸‹", "2åˆ†é–“å®‰å…¨ã«è‡ªç«‹"] },
    { id: 3, title: "3. åº§ä½ä¿æŒï¼ˆèƒŒã‚‚ãŸã‚Œãªã—ï¼‰", shortTitle: "åº§ä½ä¿æŒ", isBBS9: false, isScreening: false, criteria: ["10ç§’ä¿æŒä¸èƒ½", "10ç§’ä¿æŒ", "30ç§’ä¿æŒ", "2åˆ†é–“ç›£è¦–ä¸‹", "è…•ã‚’çµ„ã‚“ã§2åˆ†é–“è‡ªç«‹"] },
    { id: 4, title: "4. ç«‹ä½ã‹ã‚‰ã®ç€åº§", shortTitle: "ç€åº§", isBBS9: true, isScreening: false, criteria: ["ä»‹åŠ©ãŒå¿…è¦", "ä¸‹é™ãŒåˆ¶å¾¡ä¸èƒ½", "ä¸‹è…¿å¾Œé¢ã‚’æ¤…å­ã«å½“ã¦ã¦åˆ¶å¾¡", "æ‰‹ã§ä¸‹é™ã‚’åˆ¶å¾¡", "å®‰å…¨ã«ç€åº§"] },
    { id: 5, title: "5. ç§»ä¹—å‹•ä½œ", shortTitle: "ç§»ä¹—", isBBS9: true, isScreening: false, criteria: ["2åã®ä»‹åŠ©ãŒå¿…è¦", "1åã®ä»‹åŠ©ãŒå¿…è¦", "è¨€èªçš„æŒ‡ç¤ºã‚„ç›£è¦–ãŒå¿…è¦", "æ‰‹ã«ã‚ˆã‚‹æ”¯æŒãŒå¿…è¦", "å®‰å…¨ã«ç§»ä¹—"] },
    { id: 6, title: "6. é–‰çœ¼ç«‹ä½ä¿æŒ", shortTitle: "é–‰çœ¼ç«‹ä½", isBBS9: false, isScreening: false, criteria: ["è»¢å€’é˜²æ­¢ã®ä»‹åŠ©ãŒå¿…è¦", "é–‰çœ¼3ç§’ä¸å¯", "3ç§’ä¿æŒ", "10ç§’é–“ç›£è¦–ä¸‹", "10ç§’é–“è‡ªç«‹"] },
    { id: 7, title: "7. é–‰è„šç«‹ä½ä¿æŒ", shortTitle: "é–‰è„šç«‹ä½", isBBS9: true, isScreening: false, criteria: ["15ç§’ä¿æŒä¸èƒ½", "15ç§’ä¿æŒ(ä»‹åŠ©é–‹å§‹)", "30ç§’ä¿æŒä¸èƒ½", "1åˆ†é–“ç›£è¦–ä¸‹", "1åˆ†é–“è‡ªç«‹"] },
    { id: 8, title: "8. å‰æ–¹ã¸ã®ãƒªãƒ¼ãƒå‹•ä½œ", shortTitle: "å‰æ–¹ãƒªãƒ¼ãƒ", isBBS9: true, isScreening: false, criteria: ["æ”¯æŒãŒå¿…è¦", "ç›£è¦–ãŒå¿…è¦", "2ã‚¤ãƒ³ãƒä»¥ä¸Š", "5ã‚¤ãƒ³ãƒä»¥ä¸Š", "10ã‚¤ãƒ³ãƒä»¥ä¸Š"] },
    { id: 9, title: "9. åºŠã®ç‰©å“ã‚’æ‹¾ã„ä¸Šã’ã‚‹", shortTitle: "ç‰©å“æ‹¾ã„", isBBS9: true, isScreening: false, criteria: ["ä»‹åŠ©ãŒå¿…è¦", "æ‹¾ãˆãªã„", "1-2ã‚¤ãƒ³ãƒã¾ã§è¿‘ã¥ã", "ç›£è¦–ä¸‹ã§æ‹¾ã†", "å®¹æ˜“ã«æ‹¾ã†"] },
    { id: 10, title: "10. å·¦å³ã®å¾Œæ–¹æŒ¯ã‚Šè¿”ã‚Š", shortTitle: "æŒ¯ã‚Šè¿”ã‚Š", isBBS9: false, isScreening: false, criteria: ["ä»‹åŠ©ãŒå¿…è¦", "ç›£è¦–ãŒå¿…è¦", "å´æ–¹ã®ã¿", "ç‰‡å´ã®ã¿è‰¯å¥½", "ä¸¡å´è‰¯å¥½"] },
    { id: 11, title: "11. 360åº¦æ–¹å‘è»¢æ›", shortTitle: "360åº¦è»¢æ›", isBBS9: false, isScreening: true, criteria: ["ä»‹åŠ©ãŒå¿…è¦", "ç›£è¦–ãŒå¿…è¦", "å®‰å…¨ã ãŒã‚†ã£ãã‚Š", "ç‰‡å´ã®ã¿4ç§’ä»¥å†…", "ä¸¡æ–¹å‘4ç§’ä»¥å†…"] },
    { id: 12, title: "12. è¸ã¿å°ã¸ã®è¶³ã®ã›", shortTitle: "è¸ã¿å°", isBBS9: true, isScreening: true, criteria: ["è©¦è¡Œä¸èƒ½", "æœ€å°ä»‹åŠ©ã§2å›", "ç›£è¦–ä¸‹ã§4å›", "20ç§’ä»¥ä¸Šã§8å›", "20ç§’ä»¥å†…ã§8å›"] },
    { id: 13, title: "13. ã‚¿ãƒ³ãƒ‡ãƒ ç«‹ä½ï¼ˆç¶™ãè¶³ï¼‰", shortTitle: "ç¶™ãè¶³ç«‹ä½", isBBS9: false, isScreening: true, criteria: ["ãƒãƒ©ãƒ³ã‚¹å–ªå¤±", "15ç§’ä¿æŒ", "å°æ­©å¹…ã§30ç§’ä¿æŒ", "å‰æ–¹ã«ç½®ããŒãšã‚Œã‚‹", "30ç§’ä¿æŒ"] },
    { id: 14, title: "14. ç‰‡è„šç«‹ä½ä¿æŒ", shortTitle: "ç‰‡è„šç«‹ä½", isBBS9: true, isScreening: true, criteria: ["è©¦è¡Œä¸èƒ½", "3ç§’ä¿æŒä¸èƒ½", "3ç§’ä»¥ä¸Šä¿æŒ", "5ã€œ10ç§’ä¿æŒ", "10ç§’ä»¥ä¸Šä¿æŒ"] }
  ];

  const cutoffRules = [
    { profile: "elderly", mode: "full", evaluate: (score) => { if (score < 45) return { msg: "è»¢å€’ãƒªã‚¹ã‚¯ãŒæœ‰æ„ã«å¢—å¤§ï¼ˆ45ç‚¹æœªæº€ï¼‰", status: "status-alert" }; return { msg: "æ©Ÿèƒ½çš„ãƒãƒ©ãƒ³ã‚¹ã¯æ¯”è¼ƒçš„è‰¯å¥½", status: "status-good" }; } },
    { profile: "stroke", mode: "full", evaluate: (score) => { if (score >= 29) return { msg: "å®Ÿç”¨æ­©è¡Œç²å¾—ã®å¯èƒ½æ€§é«˜", status: "status-good" }; if (score >= 12) return { msg: "ä»‹åŠ©ãªã—è‡ªç«‹æ­©è¡Œã®å¯èƒ½æ€§", status: "status-warn" }; return { msg: "è»¢å€’ãƒªã‚¹ã‚¯éå¸¸ã«é«˜ã„", status: "status-alert" }; } },
    { profile: "pd", mode: "full", evaluate: (score) => { if (score < 47) return { msg: "è»¢å€’ãƒªã‚¹ã‚¯ãŒé«˜ã„çŠ¶æ…‹ï¼ˆ47ç‚¹æœªæº€ï¼‰", status: "status-alert" }; return { msg: "è»¢å€’ãƒªã‚¹ã‚¯ã¯æ¯”è¼ƒçš„ä½ã„", status: "status-good" }; } },
    { profile: "elderly", mode: "bbs9", threshold: 32, evaluate: (score) => { if (score <= 32) return { msg: "è»¢å€’ãƒªã‚¹ã‚¯ãŒæœ‰æ„ã«å¢—å¤§ï¼ˆBBS-9 ã‚«ãƒƒãƒˆã‚ªãƒ•32ç‚¹ä»¥ä¸‹ï¼‰", status: "status-alert" }; return { msg: "æ©Ÿèƒ½çš„ãƒãƒ©ãƒ³ã‚¹ã¯æ¯”è¼ƒçš„è‰¯å¥½", status: "status-good" }; } },
    { profile: "stroke", mode: "bbs9", threshold: 28, evaluate: (score) => { if (score <= 28) return { msg: "è„³å’ä¸­æ‚£è€…ã«ãŠã‘ã‚‹è»¢å€’ãƒªã‚¹ã‚¯å¢—å¤§ï¼ˆBBS-9 ã‚«ãƒƒãƒˆã‚ªãƒ•28ç‚¹ä»¥ä¸‹ï¼‰", status: "status-alert" }; return { msg: "æ©Ÿèƒ½çš„ãƒãƒ©ãƒ³ã‚¹ã¯æ¯”è¼ƒçš„è‰¯å¥½", status: "status-good" }; } }
  ];

  const mdcCalculators = {
    elderly: (prevScore) => {
      if (prevScore >= 45) return 4.0;
      if (prevScore >= 35) return 5.0;
      if (prevScore >= 25) return 7.0;
      return 5.0; 
    },
    stroke: (prevScore) => 7.0, 
    pd: (prevScore) => 5.0      
  };

  // ã‚«ãƒƒãƒˆã‚ªãƒ•åˆ¤å®šã®å‡ºå…¸ï¼ˆå±æ€§ãƒ»ãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
  const cutoffReferences = {
    elderly_full: [
      { author: "Shumway-Cook A et al.", year: "1997", title: "Predicting the probability for falls in community-dwelling older adults. Physical Therapy.", note: "é«˜é½¢è€…45ç‚¹æœªæº€ã§è»¢å€’ãƒªã‚¹ã‚¯æœ‰æ„å¢—å¤§ã®é–¾å€¤ã¨ã—ã¦åºƒãå¼•ç”¨ã€‚RehabMeasures Databaseç­‰ã§å‚ç…§ã€‚" }
    ],
    elderly_bbs9: [
      { author: "Hohtari-KivimÃ¤ki U et al.", year: "-", title: "BBS-9ï¼ˆçŸ­ç¸®ç‰ˆï¼‰ã®è»¢å€’äºˆæ¸¬ã‚«ãƒƒãƒˆã‚ªãƒ•ã«é–¢ã™ã‚‹æ¤œè¨¼ç ”ç©¶ã€‚", note: "BBS-9ã‚¹ã‚³ã‚¢32/33ç‚¹ã‚’å¢ƒç•Œã¨ã™ã‚‹è»¢å€’ãƒªã‚¹ã‚¯ã®å ±å‘Šã«åŸºã¥ãã€‚" }
    ],
    stroke_full: [
      { author: "Louie DR, Eng JJ.", year: "2008", title: "Berg Balance Scale score at admission can predict walking suitable for community ambulation at discharge from inpatient stroke rehabilitation. J Rehabil Med.", note: "å…¥é™¢æ™‚29ç‚¹ä»¥ä¸Šã§å®Ÿç”¨æ­©è¡Œç²å¾—ã€12ç‚¹ä»¥ä¸Šã§ä»‹åŠ©ãªã—è‡ªç«‹æ­©è¡Œã®å¯èƒ½æ€§ã€‚" }
    ],
    stroke_bbs9: [
      { author: "è„³å’ä¸­ã«ãŠã‘ã‚‹BBSçŸ­ç¸®ç‰ˆã®å ±å‘Š", year: "-", title: "è„³å’ä¸­æ‚£è€…ã®è»¢å€’ãƒªã‚¹ã‚¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã«ãŠã‘ã‚‹BBS-9ã‚«ãƒƒãƒˆã‚ªãƒ•ï¼ˆ28ç‚¹ä»¥ä¸‹ç­‰ï¼‰ã®çŸ¥è¦‹ã«åŸºã¥ãã€‚", note: "æ–½è¨­ãƒ»å¯¾è±¡ã«ã‚ˆã‚Šç•°ãªã‚‹å ´åˆã‚ã‚Šã€‚Scoping reviewç­‰ã‚’å‚ç…§ã€‚" }
    ],
    pd_full: [
      { author: "Leddy AL et al.", year: "2011", title: "Accuracy of Fall Prediction in Parkinson Disease: Six-Month and 12-Month Prospective Analyses. Physical Therapy.", note: "BBS 47ç‚¹æœªæº€ã§è»¢å€’ãƒªã‚¹ã‚¯ãŒé«˜ã„çŠ¶æ…‹ã‚’ç¤ºã™å¢ƒç•Œç·šï¼ˆAUC 0.68â€“0.87ï¼‰ã€‚" }
    ]
  };

  // MDCåˆ¤å®šã®å‡ºå…¸ï¼ˆå±æ€§åˆ¥ï¼‰
  const mdcReferences = {
    elderly: [
      { author: "Academy of Neurologic Physical Therapy.", year: "-", title: "BERG BALANCE SCALE (BBS) Pocket Guide.", note: "é«˜é½¢è€…ã§ã¯ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚¹ã‚³ã‚¢å¸¯ã«ã‚ˆã‚ŠMDCãŒå¤‰å‹•ï¼ˆä¾‹: 45â€“56ç‚¹ã§3.3â€“4.0ç‚¹ã€25â€“34ç‚¹ã§6.3â€“7.0ç‚¹ç­‰ï¼‰ã€‚" }
    ],
    stroke: [
      { author: "Academy of Neurologic Physical Therapy.", year: "-", title: "BERG BALANCE SCALE (BBS) Pocket Guide.", note: "è„³å’ä¸­ï¼ˆæ€¥æ€§æœŸï¼‰ã§MDC 6.0â€“7.0ç‚¹ã€‚æ¸¬å®šèª¤å·®ã‚’è¶…ãˆãŸçœŸã®å¤‰åŒ–ã®åˆ¤å®šã«ç”¨ã„ã‚‹ã€‚" }
    ],
    pd: [
      { author: "Academy of Neurologic Physical Therapy.", year: "-", title: "BERG BALANCE SCALE (BBS) Pocket Guide.", note: "ãƒ‘ãƒ¼ã‚­ãƒ³ã‚½ãƒ³ç—…ã§MDC 5.0ç‚¹ã€‚5ç‚¹ä»¥ä¸Šã®å¤‰åŒ–ã§çœŸã®æ”¹å–„/æ‚ªåŒ–ã¨è§£é‡ˆã™ã‚‹æ ¹æ‹ ã€‚" }
    ]
  };

  function showReferencePanel(type) {
    const panel = document.getElementById('reference-panel');
    const profile = appState.profile;
    const mode = appState.mode;
    let refs = [];
    let heading = '';
    if (type === 'cutoff') {
      const key = profile + '_' + mode;
      refs = cutoffReferences[key] || [];
      heading = 'ã‚«ãƒƒãƒˆã‚ªãƒ•åˆ¤å®šã®å‡ºå…¸ï¼ˆ' + (profile === 'elderly' ? 'ä¸€èˆ¬çš„ãªé«˜é½¢è€…' : profile === 'stroke' ? 'è„³å’ä¸­ï¼ˆå…¥é™¢æ™‚ï¼‰' : 'ãƒ‘ãƒ¼ã‚­ãƒ³ã‚½ãƒ³ç—…') + 'ãƒ»' + (mode === 'full' ? 'ãƒ•ãƒ«14é …ç›®' : mode === 'bbs9' ? 'BBS-9' : 'ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°') + 'ï¼‰';
    } else {
      refs = mdcReferences[profile] || [];
      heading = 'MDCåˆ¤å®šã®å‡ºå…¸ï¼ˆ' + (profile === 'elderly' ? 'ä¸€èˆ¬çš„ãªé«˜é½¢è€…' : profile === 'stroke' ? 'è„³å’ä¸­' : 'ãƒ‘ãƒ¼ã‚­ãƒ³ã‚½ãƒ³ç—…') + 'ï¼‰';
    }
    const closeBtn = '<button type="button" class="btn-ref" style="margin-top:8px;" onclick="document.getElementById(\'reference-panel\').style.display=\'none\'">é–‰ã˜ã‚‹</button>';
    if (refs.length === 0) {
      panel.innerHTML = '<span class="ref-heading">' + heading + '</span><p>è©²å½“ã™ã‚‹å‡ºå…¸æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>' + closeBtn;
    } else {
      panel.innerHTML = '<span class="ref-heading">' + heading + '</span>' + refs.map(r =>
        '<div class="ref-entry">' +
        '<strong>' + (r.author || '') + (r.year ? ' (' + r.year + '). ' : '. ') + '</strong>' +
        (r.title ? r.title + (r.note ? '<br><span style="color:var(--text-muted);">' + r.note + '</span>' : '') : r.note) +
        '</div>'
      ).join('') + closeBtn;
    }
    panel.style.display = 'block';
  }

  let appState = { mode: 'full', profile: 'elderly', scores: new Array(14).fill(null), prevScore: null, prevMode: null };
  let radarChartInstance = null;

  function renderItems() {
    const formContainer = document.getElementById('evaluation-form');
    formContainer.innerHTML = '';
    appState.scores = new Array(14).fill(null); 

    bbsItems.forEach((item, index) => {
      if (appState.mode === 'bbs9' && !item.isBBS9) return;
      if (appState.mode === 'screening' && !item.isScreening) return;

      const itemDiv = document.createElement('div');
      itemDiv.className = 'bbs-item';
      let radiosHtml = '<div class="radio-group-vertical">';
      for (let i = 0; i <= 4; i++) {
        radiosHtml += `
          <label class="radio-option">
            <input type="radio" name="item_${index}" value="${i}" onchange="updateScore(${index}, ${i})">
            <span class="score-badge">${i}</span>
            <span class="criteria-text">${item.criteria[i]}</span>
          </label>
        `;
      }
      radiosHtml += '</div>';
      itemDiv.innerHTML = `<div class="bbs-item-title">${item.title}</div>${radiosHtml}`;
      formContainer.appendChild(itemDiv);
    });

    const maxScoreMap = { 'full': 56, 'bbs9': 36, 'screening': 16 };
    document.getElementById('max-score').innerText = maxScoreMap[appState.mode];
    
    document.getElementById('saveBtn').style.display = 'none';
    document.getElementById('mdc-result').style.display = 'none';
    updateVisuals();
  }

  window.updateScore = function(index, value) {
    appState.scores[index] = parseInt(value, 10);
    updateVisuals();
  };

  function updateVisuals() {
    let sum = 0, answeredCount = 0;
    let targetItems = [];

    bbsItems.forEach((item, idx) => {
      let isTarget = false;
      if (appState.mode === 'full') isTarget = true;
      if (appState.mode === 'bbs9' && item.isBBS9) isTarget = true;
      if (appState.mode === 'screening' && item.isScreening) isTarget = true;
      
      if (isTarget) {
        targetItems.push({ idx: idx, item: item });
        if (appState.scores[idx] !== null) { sum += appState.scores[idx]; answeredCount++; }
      }
    });

    document.getElementById('total-score').innerText = answeredCount === 0 ? "-" : sum;
    const msgEl = document.getElementById('cutoff-message');
    const mdcEl = document.getElementById('mdc-result');
    document.getElementById('result-panel').classList.remove('status-good', 'status-warn', 'status-alert');
    
    const saveBtn = document.getElementById('saveBtn');

    if (answeredCount < targetItems.length) {
      msgEl.innerText = `æ®‹ã‚Š ${targetItems.length - answeredCount} é …ç›®ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚`;
      msgEl.className = "";
      saveBtn.style.display = 'none';
      mdcEl.style.display = 'none';
    } else {
      const rule = cutoffRules.find(r => r.profile === appState.profile && r.mode === appState.mode);
      if (rule) {
        const result = rule.evaluate(sum);
        msgEl.innerText = result.msg;
        document.getElementById('result-panel').classList.add(result.status);
      } else {
        msgEl.innerText = "ã™ã¹ã¦ã®è©•ä¾¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
        msgEl.className = "status-good";
      }
      saveBtn.style.display = 'block';

      if (appState.prevScore !== null && appState.prevMode === appState.mode) {
        const diff = sum - appState.prevScore;
        const requiredMdc = mdcCalculators[appState.profile] ? mdcCalculators[appState.profile](appState.prevScore) : null;

        if (requiredMdc !== null) {
          mdcEl.style.display = 'block';
          const isTrueChange = Math.abs(diff) >= requiredMdc;
          const sign = diff > 0 ? "+" : "";
          
          if (isTrueChange) {
            mdcEl.className = diff > 0 ? "status-good" : "status-alert";
            const trend = diff > 0 ? "æ”¹å–„" : "æ‚ªåŒ–";
            mdcEl.innerHTML = `
              <div class="mdc-title">ğŸ“ˆ MDCåˆ¤å®šï¼šæœ‰æ„ãªå¤‰åŒ–ï¼ˆçµ±è¨ˆå­¦çš„æœ‰æ„ï¼‰</div>
              å‰å›ï¼ˆ${appState.prevScore}ç‚¹ï¼‰ã‹ã‚‰ <strong>${sign}${diff}ç‚¹</strong> ã®å¤‰åŒ–ã§ã™ã€‚<br>
              ã“ã®å±æ€§ã«ãŠã‘ã‚‹MDCï¼ˆ${requiredMdc}ç‚¹ï¼‰ã‚’æº€ãŸã—ã¦ãŠã‚Šã€æ¸¬å®šèª¤å·®ã‚’è¶…ãˆãŸ<strong>çœŸã®${trend}</strong>ã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚
            `;
          } else {
            mdcEl.className = "status-warn";
            mdcEl.innerHTML = `
              <div class="mdc-title">ğŸ“Š MDCåˆ¤å®šï¼šèª¤å·®ã®ç¯„å›²å†…</div>
              å‰å›ï¼ˆ${appState.prevScore}ç‚¹ï¼‰ã‹ã‚‰ <strong>${sign}${diff}ç‚¹</strong> ã®å¤‰åŒ–ã§ã™ã€‚<br>
              ã“ã®å±æ€§ã«ãŠã‘ã‚‹MDCï¼ˆ${requiredMdc}ç‚¹ï¼‰ã«æº€ãŸãªã„ãŸã‚ã€æ—¥å†…å¤‰å‹•ã‚„æ¸¬å®šèª¤å·®ã«ã‚ˆã‚‹ãƒã‚¤ã‚ºã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
            `;
          }
        }
      } else if (appState.prevScore !== null && appState.prevMode !== appState.mode) {
         mdcEl.style.display = 'block';
         mdcEl.className = "status-warn";
         mdcEl.innerHTML = `âš ï¸ å‰å›ã®è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ï¼ˆ${appState.prevMode}ï¼‰ã¨ç•°ãªã‚‹ãŸã‚ã€MDCåˆ¤å®šã¯è¡Œãˆã¾ã›ã‚“ã€‚`;
      } else {
         mdcEl.style.display = 'none';
      }
    }

    const chartCont = document.getElementById('chart-container');
    const progWrapper = document.getElementById('progress-wrapper');
    const screenCont = document.getElementById('screening-alerts');
    
    chartCont.style.display = 'none';
    progWrapper.style.display = 'none';
    screenCont.style.display = 'none';

    if (appState.mode === 'full') {
      chartCont.style.display = 'block';
      drawRadarChart(targetItems);
    } else if (appState.mode === 'bbs9') {
      progWrapper.style.display = 'block';
      const percentage = (sum / 36) * 100;
      const bar = document.getElementById('progress-bar');
      bar.style.width = `${percentage}%`;
      
      const rule = cutoffRules.find(r => r.profile === appState.profile && r.mode === 'bbs9');
      if (rule && rule.threshold) {
        bar.style.backgroundColor = sum <= rule.threshold ? '#dc3545' : 'var(--accent)';
        const markerContainer = document.getElementById('cutoff-marker-container');
        const thresholdPct = (rule.threshold / 36) * 100;
        markerContainer.innerHTML = `<div class="cutoff-marker" style="left: ${thresholdPct}%"></div><div class="cutoff-label" style="left: ${thresholdPct}%">ã‚«ãƒƒãƒˆã‚ªãƒ•: ${rule.threshold}ç‚¹</div>`;
      }
    } else if (appState.mode === 'screening') {
      screenCont.style.display = 'block';
      drawScreeningAlerts(targetItems);
    }
  }

  function drawRadarChart(targetItems) {
    const ctx = document.getElementById('radarChart').getContext('2d');
    // ã“ã“ã§ `item.shortTitle` ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´ï¼
    const labels = targetItems.map(t => t.item.shortTitle);
    const dataPoints = targetItems.map(t => appState.scores[t.idx] !== null ? appState.scores[t.idx] : 0);
    
    if (radarChartInstance) { radarChartInstance.destroy(); }
    
    radarChartInstance = new Chart(ctx, { 
      type: 'radar', 
      data: { 
        labels: labels, 
        datasets: [{ 
          label: 'ã‚¹ã‚³ã‚¢', 
          data: dataPoints, 
          backgroundColor: 'rgba(0, 86, 179, 0.2)', 
          borderColor: 'rgba(0, 86, 179, 1)', 
          pointBackgroundColor: 'rgba(0, 86, 179, 1)', 
          borderWidth: 2 
        }] 
      }, 
      options: { 
        responsive: true, 
        maintainAspectRatio: false, 
        scales: { 
          r: { 
            min: 0, max: 4, ticks: { stepSize: 1 },
            pointLabels: {
              font: { size: 10 } // ã‚¹ãƒãƒ›ã§ã‚‚è¦‹ã‚„ã™ã„ã‚ˆã†ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´
            }
          } 
        }, 
        plugins: { legend: { display: false } } 
      } 
    });
  }

  function drawScreeningAlerts(targetItems) {
    const container = document.getElementById('screening-alerts');
    container.innerHTML = ''; 
    targetItems.forEach(t => {
      const score = appState.scores[t.idx];
      if (score === null) return;
      const alertDiv = document.createElement('div');
      if (score < 3) { alertDiv.className = 'alert-box alert-danger'; alertDiv.innerHTML = `âš ï¸ [è»¢å€’ãƒªã‚¹ã‚¯é«˜] ${t.item.title} ãŒè‡ªç«‹ã—ã¦è¡Œãˆã¾ã›ã‚“ (${score}ç‚¹)`; } 
      else { alertDiv.className = 'alert-box alert-safe'; alertDiv.innerHTML = `âœ… ${t.item.title} ã¯æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã¾ã™ (${score}ç‚¹)`; }
      container.appendChild(alertDiv);
    });
  }

  const patientIdInput = document.getElementById('patientId');
  const historyMsg = document.getElementById('history-message');

  document.getElementById('saveBtn').addEventListener('click', () => {
    const pid = patientIdInput.value.trim();
    if (!pid) { alert("ä¿å­˜ã™ã‚‹ã«ã¯ã€ä¸Šéƒ¨ã®ã€Œæ‚£è€…IDã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"); return; }
    
    let sum = 0;
    appState.scores.forEach(s => { if(s !== null) sum += s; });

    const record = { date: new Date().toLocaleDateString(), mode: appState.mode, profile: appState.profile, score: sum };
    let db = JSON.parse(localStorage.getItem('bbs_database')) || {};
    if (!db[pid]) db[pid] = [];
    db[pid].push(record);
    localStorage.setItem('bbs_database', JSON.stringify(db));
    
    historyMsg.style.color = "green";
    historyMsg.innerText = `âœ… ${record.date} ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆ${sum}ç‚¹ï¼‰ã‚’ç«¯æœ«ã«ä¿å­˜ã—ã¾ã—ãŸï¼`;
  });

  document.getElementById('loadBtn').addEventListener('click', () => {
    const pid = patientIdInput.value.trim();
    if (!pid) { alert("èª­ã¿è¾¼ã‚€æ‚£è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

    let db = JSON.parse(localStorage.getItem('bbs_database')) || {};
    
    if (db[pid] && db[pid].length > 0) {
      const lastRecord = db[pid][db[pid].length - 1];
      historyMsg.style.color = "var(--accent)";
      historyMsg.innerText = `ğŸ“… å‰å›ï¼ˆ${lastRecord.date}ï¼‰ã®è¨˜éŒ²ã‚’èª­è¾¼ä¸­...ï¼ˆè©•ä¾¡ã‚’å®Œäº†ã™ã‚‹ã¨MDCåˆ¤å®šãŒå‡ºã¾ã™ï¼‰`;
      
      appState.prevScore = lastRecord.score; 
      appState.prevMode = lastRecord.mode;
      updateVisuals();
    } else {
      historyMsg.style.color = "gray";
      historyMsg.innerText = "ã“ã®IDã®éå»ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
      appState.prevScore = null;
      appState.prevMode = null;
    }
  });

  document.getElementById('evalMode').addEventListener('change', (e) => { appState.mode = e.target.value; renderItems(); });
  document.getElementById('patientProfile').addEventListener('change', (e) => { appState.profile = e.target.value; updateVisuals(); });

  document.getElementById('btnCutoffRef').addEventListener('click', () => showReferencePanel('cutoff'));
  document.getElementById('btnMdcRef').addEventListener('click', () => showReferencePanel('mdc'));

  renderItems(); 
</script>
</body>
</html>
